<html xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns:st1="urn:schemas-microsoft-com:office:smarttags"
xmlns="http://www.w3.org/TR/REC-html40">


<!-- Mirrored from www.kerneltravel.net/kernel-book/ç¬¬ä¹ç« %20Ext2æ–‡ä»¶ç³»ç»Ÿ/9.5.3.htm by HTTrack Website Copier/3.x [XR&CO'2008], Sat, 29 Dec 2012 03:01:25 GMT -->
<head>
<meta http-equiv=Content-Type content="text/html; charset=gb2312">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 11">
<meta name=Originator content="Microsoft Word 11">
<link rel=File-List href="9.5.3.files/filelist.html">
<title>·ÖÅäÒ»¸öÊı¾İ¿é</title>
<o:SmartTagType namespaceuri="urn:schemas-microsoft-com:office:smarttags"
 name="chsdate" downloadurl=""/>
<!--[if gte mso 9]><xml>
 <o:DocumentProperties>
  <o:Author>CLJ</o:Author>
  <o:Template>Normal</o:Template>
  <o:LastAuthor>CLJ</o:LastAuthor>
  <o:Revision>2</o:Revision>
  <o:TotalTime>0</o:TotalTime>
  <o:Created>2007-08-16T10:13:00Z</o:Created>
  <o:LastSaved>2007-08-16T10:13:00Z</o:LastSaved>
  <o:Pages>1</o:Pages>
  <o:Words>825</o:Words>
  <o:Characters>4706</o:Characters>
  <o:Lines>39</o:Lines>
  <o:Paragraphs>11</o:Paragraphs>
  <o:CharactersWithSpaces>5520</o:CharactersWithSpaces>
  <o:Version>11.5606</o:Version>
 </o:DocumentProperties>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:GrammarState>Clean</w:GrammarState>
  <w:PunctuationKerning/>
  <w:DrawingGridVerticalSpacing>7.8 °õ</w:DrawingGridVerticalSpacing>
  <w:DisplayHorizontalDrawingGridEvery>0</w:DisplayHorizontalDrawingGridEvery>
  <w:DisplayVerticalDrawingGridEvery>2</w:DisplayVerticalDrawingGridEvery>
  <w:ValidateAgainstSchemas/>
  <w:SaveIfXMLInvalid>false</w:SaveIfXMLInvalid>
  <w:IgnoreMixedContent>false</w:IgnoreMixedContent>
  <w:AlwaysShowPlaceholderText>false</w:AlwaysShowPlaceholderText>
  <w:Compatibility>
   <w:SpaceForUL/>
   <w:BalanceSingleByteDoubleByteWidth/>
   <w:DoNotLeaveBackslashAlone/>
   <w:ULTrailSpace/>
   <w:DoNotExpandShiftReturn/>
   <w:AdjustLineHeightInTable/>
   <w:BreakWrappedTables/>
   <w:SnapToGridInCell/>
   <w:WrapTextWithPunct/>
   <w:UseAsianBreakRules/>
   <w:DontGrowAutofit/>
   <w:UseFELayout/>
  </w:Compatibility>
  <w:BrowserLevel>MicrosoftInternetExplorer4</w:BrowserLevel>
 </w:WordDocument>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:LatentStyles DefLockedState="false" LatentStyleCount="156">
 </w:LatentStyles>
</xml><![endif]--><!--[if !mso]><object
 classid="clsid:38481807-CA0E-42D2-BF39-B33AF135CC4D" id=ieooui></object>
<style>
st1\:*{behavior:url(#ieooui) }
</style>
<![endif]-->
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Wingdings;
	panose-1:5 0 0 0 0 0 0 0 0 0;
	mso-font-charset:2;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:0 268435456 0 0 -2147483648 0;}
@font-face
	{font-family:ËÎÌå;
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-alt:SimSun;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 135135232 16 0 262145 0;}
@font-face
	{font-family:"\@ËÎÌå";
	panose-1:2 1 6 0 3 1 1 1 1 1;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:3 135135232 16 0 262145 0;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	mso-pagination:none;
	font-size:10.5pt;
	mso-bidi-font-size:10.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:ËÎÌå;
	mso-font-kerning:1.0pt;}
p.MsoPlainText, li.MsoPlainText, div.MsoPlainText
	{margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	mso-pagination:none;
	font-size:10.5pt;
	mso-bidi-font-size:10.0pt;
	font-family:ËÎÌå;
	mso-hansi-font-family:"Courier New";
	mso-bidi-font-family:"Times New Roman";
	color:black;
	mso-font-kerning:1.0pt;}
span.GramE
	{mso-style-name:"";
	mso-gram-e:yes;}
 /* Page Definitions */
 @page
	{mso-page-border-surround-header:no;
	mso-page-border-surround-footer:no;}
@page Section1
	{size:595.3pt 841.9pt;
	margin:72.0pt 90.0pt 72.0pt 90.0pt;
	mso-header-margin:42.55pt;
	mso-footer-margin:49.6pt;
	mso-paper-source:0;
	layout-grid:15.6pt;}
div.Section1
	{page:Section1;}
 /* List Definitions */
 @list l0
	{mso-list-id:136842676;
	mso-list-type:simple;
	mso-list-template-ids:1937021516;}
@list l0:level1
	{mso-level-number-format:bullet;
	mso-level-text:¡¤;
	mso-level-tab-stop:21.25pt;
	mso-level-number-position:left;
	margin-left:21.25pt;
	text-indent:-21.25pt;
	font-family:ËÎÌå;
	mso-hansi-font-family:Wingdings;}
ol
	{margin-bottom:0cm;}
ul
	{margin-bottom:0cm;}
-->
</style>
<!--[if gte mso 10]>
<style>
 /* Style Definitions */
 table.MsoNormalTable
	{mso-style-name:ÆÕÍ¨±í¸ñ;
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	mso-style-noshow:yes;
	mso-style-parent:"";
	mso-padding-alt:0cm 5.4pt 0cm 5.4pt;
	mso-para-margin:0cm;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.0pt;
	font-family:"Times New Roman";
	mso-ansi-language:#0400;
	mso-fareast-language:#0400;
	mso-bidi-language:#0400;}
</style>
<![endif]-->
</head>

<body lang=ZH-CN style='tab-interval:21.0pt;text-justify-trim:punctuation'>

<div class=Section1 style='layout-grid:15.6pt'>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><st1:chsdate Year="1899" Month="12" Day="30"
IsLunarDate="False" IsROCDate="False" w:st="on"><span lang=EN-US
 style='font-family:ËÎÌå;mso-hansi-font-family:"Times New Roman";color:black;
 mso-font-kerning:0pt'>9.5.3</span></st1:chsdate><span lang=EN-US
style='font-family:ËÎÌå;mso-hansi-font-family:"Times New Roman";color:black;
mso-font-kerning:0pt'> </span><span style='font-family:ËÎÌå;mso-hansi-font-family:
"Times New Roman";color:black;mso-font-kerning:0pt'>·ÖÅäÒ»¸öÊı¾İ¿é<span lang=EN-US><o:p></o:p></span></span></p>

<p class=MsoPlainText><span lang=EN-US style='mso-font-kerning:0pt'><span
style='mso-spacerun:yes'>&nbsp;&nbsp; </span></span>µ±ÄÚºËÒª·ÖÅäÒ»¸öĞÂµÄÊı¾İ¿éÀ´±£´æ<span
lang=EN-US>Ext2</span>ÆÕÍ¨ÎÄ¼şµÄÊı¾İÊ±£¬¾Íµ÷ÓÃ<span lang=EN-US>ext2_get_block(<span
style='mso-spacerun:yes'>&nbsp; </span>)</span>º¯Êı¡£Õâ¸öº¯ÊıÒÀ´Î´¦ÀíÔÚ¡°Êı¾İ¿éÑ°Ö·¡±²¿·ÖËùÃèÊöµÄÄÇĞ©Êı¾İ½á¹¹£¬²¢ÔÚ±ØÒªÊ±µ÷ÓÃ<span
lang=EN-US>ext2_alloc_block(<span style='mso-spacerun:yes'>&nbsp; </span>)</span>º¯ÊıÔÚ<span
lang=EN-US>Ext2</span>·ÖÇøÊµ¼ÊËÑË÷Ò»¸ö¿ÕÏĞµÄ¿é¡£</p>

<p class=MsoPlainText><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp; </span></span>ÎªÁË¼õÉÙÎÄ¼şµÄËéÆ¬£¬<span lang=EN-US>Ext2</span>ÎÄ¼şÏµÍ³¾¡Á¦ÔÚÒÑ·ÖÅä¸øÎÄ¼şµÄ×îºóÒ»¸ö<span
class=GramE>¿é¸½½ü</span>ÕÒÒ»¸ö<span class=GramE>ĞÂ¿é·Ö</span>Åä¸ø¸ÃÎÄ¼ş¡£Èç¹ûÊ§°Ü£¬<span
lang=EN-US>Ext2</span>ÎÄ¼şÏµÍ³ÓÖÔÚ°üº¬Õâ¸öÎÄ¼şË÷Òı½ÚµãµÄ¿é×éÖĞËÑÑ°Ò»¸öĞÂµÄ¿é¡£×÷Îª×îºóÒ»¸ö°ì·¨£¬¿ÉÒÔ´ÓÆäËüÒ»¸ö¿é×éÖĞ»ñµÃ¿ÕÏĞ¿é¡£</p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp; </span>Ext2</span><span
style='font-family:ËÎÌå;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>ÎÄ¼şÏµÍ³Ê¹ÓÃÊı¾İ¿éµÄÔ¤·ÖÅä²ßÂÔ¡£ÎÄ¼ş²¢²»½ö½ö»ñµÃËùĞèÒªµÄ¿é£¬¶øÊÇ»ñµÃÒ»×é¶à´ï</span><span
lang=EN-US>8</span><span style='font-family:ËÎÌå;mso-ascii-font-family:"Times New Roman";
mso-hansi-font-family:"Times New Roman"'>¸öÁÚ½ÓµÄ¿é¡£</span><span lang=EN-US>ext2_inode_info</span><span
style='font-family:ËÎÌå;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>½á¹¹µÄ</span><span lang=EN-US>i_prealloc_count</span><span
style='font-family:ËÎÌå;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>Óò´æ·ÅÔ¤·ÖÅä¸øÄ³Ò»ÎÄ¼şµ«»¹Ã»ÓĞÊ¹ÓÃµÄÊı¾İ¿éÊı£¬¶ø</span><span lang=EN-US>i_prealloc_block</span><span
style='font-family:ËÎÌå;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>Óò´æ·ÅÏÂÒ»´ÎÒªÊ¹ÓÃµÄÔ¤·ÖÅä¿éµÄÂß¼­¿éºÅ¡£<span class=GramE>µ±ÏÂÁĞ</span>Çé¿ö·¢ÉúÊ±£¬¼´ÎÄ¼ş±»¹Ø±ÕÊ±£¬ÎÄ¼ş±»É¾³ıÊ±£¬»ò¹ØÓÚÒı·¢¿éÔ¤·ÖÅäµÄĞ´²Ù×÷¶øÑÔ£¬ÓĞÒ»¸öĞ´²Ù×÷²»ÊÇË³ĞòµÄÊ±ºò£¬¾ÍÊÍ·ÅÔ¤·ÖÅäµ«Ò»Ö±Ã»ÓĞÊ¹ÓÃµÄ¿é</span><span
lang=EN-US style='font-family:ËÎÌå;mso-hansi-font-family:"Times New Roman";
color:black;mso-font-kerning:0pt'><o:p></o:p></span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US style='font-family:ËÎÌå;mso-hansi-font-family:
"Times New Roman";color:black;mso-font-kerning:0pt'><span
style='mso-spacerun:yes'>&nbsp;&nbsp; </span></span><span style='font-family:
ËÎÌå;mso-hansi-font-family:"Times New Roman";color:black;mso-font-kerning:0pt'>ÏÂÃæÎÒÃÇÀ´¿´Ò»ÏÂ</span><span
lang=EN-US>ext2_get_block(<span style='mso-spacerun:yes'>&nbsp; </span>)</span><span
style='font-family:ËÎÌå;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>º¯Êı£¬Æä´úÂëÔÚ</span><span lang=EN-US>fs/ext2/inode.c</span><span
style='font-family:ËÎÌå;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:
"Times New Roman"'>ÖĞ£º</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp; </span>/*</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp; </span>* Allocation strategy is simple: if we
have to allocate something, we will</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp; </span>* have to go the whole way to leaf. So
let's do it before attaching anything</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp; </span>* <span class=GramE>to</span> tree, set
linkage between the newborn blocks, write them if sync is</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp; </span>* required, recheck the path, free and
repeat if check fails, otherwise</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp; </span>* set the last missing link (that will
protect us from any truncate-generated</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp; </span>* removals - all blocks on the path are
immune now) and possibly force the</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp; </span>* write on the parent block.</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp; </span>* That has a nice additional property:
no special recovery from the failed</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp; </span>* <span class=GramE>allocations</span>
is needed - we simply release blocks and do not touch anything</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp; </span>* <span class=GramE>reachable</span>
from inode.</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp; </span>*/</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span class=GramE><span lang=EN-US>static</span></span><span
lang=EN-US> int ext2_get_block(struct inode *inode, long iblock, struct buffer_head
*bh_result, int create)</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp; </span>{</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>int</span> err = -EIO;</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span class=GramE>int</span> offsets[4];</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Indirect <span class=GramE>chain[</span>4];</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Indirect *partial;</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span class=GramE>unsigned</span> long goal;</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span class=GramE>int</span> left;</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span class=GramE>int</span> depth = ext2_block_to_path(inode, iblock,
offsets); </span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span class=GramE>if</span> (depth == 0)</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span class=GramE>goto</span> out;</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>lock_<span class=GramE>kernel(</span>);</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span class=GramE><span lang=EN-US>reread</span></span><span
lang=EN-US>:</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span class=GramE>partial</span> = ext2_get_branch(inode, depth,
offsets, chain, &amp;err);</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>/* <span class=GramE>Simplest</span> case - block found, no allocation
needed */</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span class=GramE>if</span> (!partial) {</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US>got_it:</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp; </span><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>bh_result-&gt;b_dev
= inode-&gt;i_dev;</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>bh_result-&gt;b_blocknr = le32_to_<span class=GramE>cpu(</span>chain[depth-1].key);</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>bh_result-&gt;b_state |= (1UL &lt;&lt; BH_Mapped);</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>/* <span class=GramE>Clean</span> up and exit */</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span class=GramE>partial</span> = chain+depth-1; /* the whole chain */</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span class=GramE>goto</span> cleanup;</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>/*
Next simple case - plain lookup or failed read of indirect block */</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if</span> (!create || err == -EIO) {</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span class=GramE><span lang=EN-US>cleanup</span></span><span
lang=EN-US>:</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span class=GramE>while</span> (partial &gt; chain) {</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;</span><span
class=GramE>brelse(</span>partial-&gt;bh);</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span class=GramE>partial--</span>;</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>}</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>unlock_<span class=GramE>kernel(</span>);</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span class=GramE><span lang=EN-US>out</span></span><span
lang=EN-US>:</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span class=GramE>return</span> err;</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>}</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;</span></span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>/*</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>* Indirect block might be removed by truncate while we were</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>* reading it. Handling of that case (forget what we've got and</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>* reread) is taken out of the main path.</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>*/</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span class=GramE>if</span> (err == -EAGAIN)</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span class=GramE>goto</span> changed;</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span class=GramE>if</span> (ext2_find_goal(inode, iblock, chain,
partial, &amp;goal) &lt; 0)</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp; </span><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span
class=GramE>goto</span> changed;</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>left</span> = (chain + depth) - partial;</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span class=GramE>err</span> = ext2_alloc_branch(inode, left, goal,</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>offsets<span class=GramE>+(</span>partial-chain), partial);</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span class=GramE>if</span> (err)</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span class=GramE>goto</span> cleanup;</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style='mso-spacerun:yes'>&nbsp;</span><span class=GramE>if</span>
(ext2_splice_branch(inode, iblock, chain, partial, left) &lt; 0)</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span class=GramE>goto</span> changed;</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>bh_result-&gt;b_state |= (1UL &lt;&lt; BH_New);</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span class=GramE>goto</span> got_it;</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span class=GramE><span lang=EN-US>changed</span></span><span
lang=EN-US>:</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span class=GramE>while</span> (partial &gt; chain) {</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span class=GramE>brelse(</span>partial-&gt;bh);</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span
class=GramE>partial--</span>;</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>goto</span> reread;</span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US>}</span></p>

<p class=MsoNormal align=left style='text-align:left;text-indent:20.4pt;
mso-layout-grid-align:none;text-autospace:none'><span style='font-family:ËÎÌå;
mso-hansi-font-family:"Times New Roman";color:black;mso-font-kerning:0pt'>¶ÔÕâ¸öº¯Êı£¬Ô´´úÂëµÄ×÷Õß¶Ô·ÖÅä²ßÂÔ¸ø³öÁË¼òµ¥µÄ×¢ÊÍ£¬ÏàĞÅ¶ÁÕß´Ó»áÖĞÁìÂÔÒ»¶ş¡£º¯ÊıµÄ²ÎÊı<span
lang=EN-US>inode</span>Ö¸ÏòÎÄ¼şµÄ<span lang=EN-US>inode</span>½á¹¹£»²ÎÊı<span lang=EN-US>iblock</span>±íÊ¾ÎÄ¼şÖĞµÄÂß¼­¿éºÅ£»²ÎÊı<span
lang=EN-US>bh_result</span>ÎªÖ¸Ïò»º³åÇøÊ×²¿µÄÖ¸Õë£¬<span lang=EN-US>buffer_head</span>½á¹¹ÒÑÔÚÉÏÒ»ÕÂ×öÁË½éÉÜ£»²ÎÊı<span
lang=EN-US>create</span>±íÊ¾ÊÇ·ñĞèÒª´´½¨¡£<span lang=EN-US><o:p></o:p></span></span></p>

<p class=MsoNormal align=left style='text-align:left;text-indent:20.4pt;
mso-layout-grid-align:none;text-autospace:none'><span style='font-family:ËÎÌå;
mso-hansi-font-family:"Times New Roman";color:black;mso-font-kerning:0pt'>ÆäÖĞ<span
lang=EN-US>Indirect</span>½á¹¹ÔÚÍ¬Ò»ÎÄ¼şÖĞ¶¨ÒåÈçÏÂ£º<span lang=EN-US><o:p></o:p></span></span></p>

<p class=MsoNormal align=left style='text-align:left;text-indent:20.4pt;
mso-layout-grid-align:none;text-autospace:none'><span class=GramE><span
lang=EN-US style='font-family:ËÎÌå;mso-hansi-font-family:"Times New Roman";
color:black;mso-font-kerning:0pt'>typedef</span></span><span lang=EN-US
style='font-family:ËÎÌå;mso-hansi-font-family:"Times New Roman";color:black;
mso-font-kerning:0pt'> struct {<o:p></o:p></span></p>

<p class=MsoNormal align=left style='text-align:left;text-indent:20.4pt;
mso-layout-grid-align:none;text-autospace:none'><span lang=EN-US
style='font-family:ËÎÌå;mso-hansi-font-family:"Times New Roman";color:black;
mso-font-kerning:0pt'><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>u32<span style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp; </span>*p;<o:p></o:p></span></p>

<p class=MsoNormal align=left style='text-align:left;text-indent:20.4pt;
mso-layout-grid-align:none;text-autospace:none'><span lang=EN-US
style='font-family:ËÎÌå;mso-hansi-font-family:"Times New Roman";color:black;
mso-font-kerning:0pt'><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>u32</span><span style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp; </span><span
style='mso-spacerun:yes'>&nbsp;</span>key;<o:p></o:p></span></p>

<p class=MsoNormal align=left style='text-align:left;text-indent:20.4pt;
mso-layout-grid-align:none;text-autospace:none'><span lang=EN-US
style='font-family:ËÎÌå;mso-hansi-font-family:"Times New Roman";color:black;
mso-font-kerning:0pt'><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>struct</span> buffer_head *bh;<o:p></o:p></span></p>

<p class=MsoNormal align=left style='text-align:left;text-indent:20.4pt;
mso-layout-grid-align:none;text-autospace:none'><span lang=EN-US
style='font-family:ËÎÌå;mso-hansi-font-family:"Times New Roman";color:black;
mso-font-kerning:0pt'>} Indirect<o:p></o:p></span></p>

<p class=MsoNormal align=left style='text-align:left;text-indent:24.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='font-family:ËÎÌå;
mso-hansi-font-family:"Times New Roman";color:black;mso-font-kerning:0pt'>ÓÃÊı×é<span
lang=EN-US>chain[4]</span>ÃèÊöËÄÖÖ²»Í¬µÄË÷Òı£¬¼´Ö±½ÓË÷Òı¡¢Ò»¼¶¼ä½ÓË÷Òı¡¢¶ş¼¶¼ä½ÓË÷Òı¡¢Èı¼¶¼ä½ÓË÷Òı¡£¾ÙÀıËµÃ÷Õâ¸ö½á¹¹¸÷¸öÓòµÄº¬Òå¡£Èç¹ûÎÄ¼şÄÚ<span
class=GramE>µÄ¿éºÅÎª</span><span lang=EN-US>8</span>£¬Ôò²»ĞèÒª¼ä½ÓË÷Òı£¬ËùÒÔÖ»ÓÃ<span lang=EN-US>chain[0]</span>Ò»¸ö<span
lang=EN-US>Indirect</span>½á¹¹£¬<span lang=EN-US>p</span>Ö¸ÏòÖ±½ÓË÷Òı±íÏÂ±êÎª<span
lang=EN-US>8</span>´¦£¬¼´£¦<span lang=EN-US>inode-&gt;u.ext2_i.i_data[8]</span>£»¶ø<span
lang=EN-US>key</span>Ôò³ÖÓĞ¸Ã±íÏîµÄÄÚÈİ£¬¼´<span class=GramE>ÎÄ¼ş¿éºÅËù</span>¶ÔÓ¦µÄÉè±¸ÉÏµÄ¿éºÅ£¨ÀàËÆÓÚÂß¼­Ò³ÃæºÅÓëÎïÀíÒ³ÃæºÅµÄ¶ÔÓ¦¹ØÏµ£©£»<span
lang=EN-US>bh</span>Îª<span lang=EN-US>NULL</span>£¬ÒòÎªÃ»ÓĞÓÃÓÚ¼ä½ÓË÷ÒıµÄ¿é¡£Èç¹ûÎÄ¼şÄÚ<span
class=GramE>µÄ¿éºÅÎª</span><span lang=EN-US>20</span>£¬ÔòĞèÒªÒ»´Î¼ä½ÓË÷Òı£¬Ë÷ÒıÒªÓÃ<span
lang=EN-US>chian[0]</span>ºÍ<span lang=EN-US>chain[1]</span>Á½¸ö±íÏî¡£µÚÒ»¸ö±íÏî<span
lang=EN-US>chian[0] </span>ÖĞ£¬Ö¸Õë<span lang=EN-US>bh</span>ÈÔÎª<span lang=EN-US>NULL</span>£¬ÒòÎªÕâÒ»²ãÃ»ÓĞÓÃÓÚ¼ä½ÓË÷ÒıµÄÊı¾İ¿é£»Ö¸Õë<span
lang=EN-US>p</span>Ö¸Ïò£¦<span lang=EN-US>inode-&gt;u.ext2_i.i_data[12]</span>£¬¼´¼ä½ÓË÷ÒıµÄ±íÏî£»¶ø<span
lang=EN-US>key</span>³ÖÓĞ¸ÃÏîµÄÄÚÈİ£¬¼´¶ÔÓ¦Éè±¸µÄ¿éºÅ¡£<span lang=EN-US>chain[1]</span>ÖĞµÄÖ¸Õë<span
lang=EN-US>bh</span>ÔòÖ¸Ïò½øĞĞ¼ä½ÓË÷ÒıµÄ<span class=GramE>¿éËùÔÚ</span>µÄ»º³åÇø£¬Õâ¸ö»º³åÇøµÄÄÚÈİ¾ÍÊÇÓÃ×÷¼ä½ÓË÷ÒıµÄÒ»¸öÕûÊıÊı×é£¬¶ø<span
lang=EN-US>p</span>Ö¸ÏòÕâ¸öÊı×éÖĞÏÂ±êÎª<span lang=EN-US>8</span>´¦£¬¶ø<span lang=EN-US>key</span>Ôò³ÖÓĞ¸ÃÏîµÄÄÚÈİ¡£ÕâÑù£¬¸ù¾İ¾ßÌåË÷ÒıµÄÉî¶È<span
lang=EN-US>depth</span>£¬Êı×é<span lang=EN-US>chain[]</span>ÖĞµÄ×îºóÒ»¸öÔªËØ£¬¼´<span
lang=EN-US>chain[depth-1].key</span>£¬×ÜÊÇ³ÖÓĞÄ¿±êÊı¾İ¿éµÄÎïÀí¿éºÅ¡£¶ø´Ó<span lang=EN-US>chain</span>£Û£İÖĞµÚÒ»¸öÔªËØ<span
lang=EN-US>chain</span>£Û<span lang=EN-US>0</span>£İµ½¾ßÌåË÷ÒıµÄ×îºóÒ»¸öÔªËØ<span lang=EN-US>chain</span>£Û<span
lang=EN-US>depth-1</span>£İ£¬ÔòÌá¹©ÁË¾ßÌåË÷ÒıµÄÕû¸öÂ·¾¶£¬¹¹³ÉÁËÒ»ÌõË÷ÒıÁ´£¬ÕâÒ²ÊÇÊı¾İÃû<span lang=EN-US>chain</span>µÄÓÉÀ´¡£<span
lang=EN-US><o:p></o:p></span></span></p>

<p class=MsoNormal align=left style='text-align:left;text-indent:24.0pt;
mso-layout-grid-align:none;text-autospace:none'><span style='font-family:ËÎÌå;
mso-hansi-font-family:"Times New Roman";color:black;mso-font-kerning:0pt'>ÁË½âÁËÒÔÉÏ»ù±¾ÄÚÈİºó£¬ÎÒÃÇÀ´¿´<span
lang=EN-US>ext2_get_block</span>£¨£©º¯ÊıµÄ¾ßÌåÊµÏÖ´úÂë£º<span lang=EN-US><o:p></o:p></span></span></p>

<p class=MsoNormal align=left style='margin-left:21.25pt;text-align:left;
text-indent:-21.25pt;mso-list:l0 level1 lfo1;tab-stops:list 21.25pt;mso-layout-grid-align:
none;text-autospace:none'><![if !supportLists]><span lang=EN-US
style='font-family:ËÎÌå;mso-hansi-font-family:Wingdings;mso-bidi-font-family:
ËÎÌå;color:black;mso-font-kerning:0pt'><span style='mso-list:Ignore'>¡¤<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]><span
style='font-family:ËÎÌå;mso-hansi-font-family:"Times New Roman";color:black;
mso-font-kerning:0pt'>Ê×ÏÈµ÷ÓÃ<span lang=EN-US>ext2_block_to_path</span>£¨£©º¯Êı£¬¸ù¾İÎÄ¼şÄÚµÄ<span
class=GramE>Âß¼­¿éºÅ</span><span lang=EN-US>iblock</span>¼ÆËã³öÕâ¸öÊı¾İ¿éÂäÔÚÄÄ¸öË÷ÒıÇø¼ä£¬Òª²ÉÓÃ¼¸ÖØË÷Òı£¨<span
lang=EN-US>1</span>±íÊ¾Ö±½Ó£©¡£Èç¹û·µ»ØÖµÎª<span lang=EN-US>0</span>£¬±íÊ¾³ö´í£¬ÒòÎªÎÄ¼ş<span
class=GramE>ÄÚ¿éºÅ</span>ÓëÉè±¸<span class=GramE>ÉÏ¿éºÅÖ®¼ä</span>ÖÁÉÙÒ²µÃÓĞÒ»´ÎË÷Òı¡£³ö´íµÄÔ­Òò¿ÉÄÜÊÇÎÄ¼ş<span
class=GramE>ÄÚ¿éºÅ</span>Ì«´ó»òÎª¸ºÖµ¡£<span lang=EN-US><o:p></o:p></span></span></p>

<p class=MsoNormal align=left style='margin-left:21.25pt;text-align:left;
text-indent:-21.25pt;mso-list:l0 level1 lfo1;tab-stops:list 21.25pt;mso-layout-grid-align:
none;text-autospace:none'><![if !supportLists]><span lang=EN-US
style='font-family:ËÎÌå;mso-hansi-font-family:Wingdings;mso-bidi-font-family:
ËÎÌå;color:black;mso-font-kerning:0pt'><span style='mso-list:Ignore'>¡¤<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]><span
lang=EN-US style='font-family:ËÎÌå;mso-hansi-font-family:"Times New Roman";
color:black;mso-font-kerning:0pt'>ext2_get_branch</span><span style='font-family:
ËÎÌå;mso-hansi-font-family:"Times New Roman";color:black;mso-font-kerning:0pt'>£¨£©º¯ÊıÉî»¯´Ó<span
lang=EN-US>ext2_block_to_path</span>£¨£©ËùÈ¡µÃµÄ½á¹û£¬¶øÕâºÏÔÚÒ»Æğ»ù±¾ÉÏÍê³ÉÁË´ÓÎÄ¼ş<span class=GramE>ÄÚ¿éºÅ</span>µ½Éè±¸<span
class=GramE>ÉÏ¿éºÅµÄ</span>Ó³Éä¡£´Ó<span lang=EN-US>ext2_get_branch</span>£¨£©·µ»ØµÄÖµÓĞÁ½ÖÖ¿ÉÄÜ¡£Ò»ÊÇ£¬Èç¹ûË³ÀûÍê³ÉÁËÓ³ÉäÔò·µ»ØÖµÎª<span
lang=EN-US>NULL</span>¡£¶şÊÇ£¬Èç¹ûÔÚÄ³Ò»<span class=GramE>Ë÷Òı¼¶</span>·¢ÏÖË÷Òı±íÄÚµÄÏàÓ¦±íÏîÎª<span
lang=EN-US>0</span>£¬ÔòËµÃ÷Õâ¸öÊı¾İ¿éÔ­À´²¢²»´æÔÚ£¬ÏÖÔÚÒòÎªĞ´²Ù×÷¶øĞèÒªÀ©³äÎÄ¼şµÄ´óĞ¡¡£´ËÊ±£¬·µ»ØÖ¸Ïò<span lang=EN-US>Indirect</span>½á¹¹µÄÖ¸Õë£¬±íÊ¾Ó³ÉäÔÚ´Ë¶ÏÁÑ¡£´ËÍâ£¬Èç¹ûÓ³ÉäµÄ¹ı³ÌÖĞ³ö´í£¬ÀıÈç£¬<span
class=GramE>¶ÁÊı¾İ¿éÊ§°Ü</span>£¬ÔòÍ¨¹ı<span lang=EN-US>err</span>·µ»ØÒ»¸ö³ö´í´úÂë¡£<span
lang=EN-US><o:p></o:p></span></span></p>

<p class=MsoNormal align=left style='margin-left:21.25pt;text-align:left;
text-indent:-21.25pt;mso-list:l0 level1 lfo1;tab-stops:list 21.25pt;mso-layout-grid-align:
none;text-autospace:none'><![if !supportLists]><span lang=EN-US
style='font-family:ËÎÌå;mso-hansi-font-family:Wingdings;mso-bidi-font-family:
ËÎÌå;color:black;mso-font-kerning:0pt'><span style='mso-list:Ignore'>¡¤<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]><span
style='font-family:ËÎÌå;mso-hansi-font-family:"Times New Roman";color:black;
mso-font-kerning:0pt'>Èç¹ûË³ÀûÍê³ÉÁËÓ³Éä£¬¾Í°ÑËùµÃ½á¹ûÌîÈë»º³åÇø½á¹¹<span lang=EN-US>bh_result</span>ÖĞ£¬È»ºó°ÑÓ³Éä¹ı³ÌÖĞ¶ÁÈëµÄ»º³åÇø£¨ÓÃÓÚ¼ä½ÓË÷Òı£©È«²¿ÊÍ·Å¡£<span
lang=EN-US><o:p></o:p></span></span></p>

<p class=MsoNormal align=left style='margin-left:21.25pt;text-align:left;
text-indent:-21.25pt;mso-list:l0 level1 lfo1;tab-stops:list 21.25pt;mso-layout-grid-align:
none;text-autospace:none'><![if !supportLists]><span lang=EN-US
style='font-family:ËÎÌå;mso-hansi-font-family:Wingdings;mso-bidi-font-family:
ËÎÌå;color:black;mso-font-kerning:0pt'><span style='mso-list:Ignore'>¡¤<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]><span
style='font-family:ËÎÌå;mso-hansi-font-family:"Times New Roman";color:black;
mso-font-kerning:0pt'>¿ÉÊÇ£¬Èç¹û<span lang=EN-US>ext2_get_branch</span>£¨£©·µ»ØÒ»¸ö·Ç<span
lang=EN-US>0</span>Ö¸Õë£¬ÄÇ¾ÍËµÃ÷Ó³ÉäÔÚÄ³Ò»<span class=GramE>Ë÷Òı¼¶</span>ÉÏ¶ÏÁÑÁË¡£¸ù¾İÓ³ÉäµÄÉî¶ÈºÍ¶ÏÁÑµÄÎ»ÖÃ£¬Õâ¸öÊı¾İ¿éÒ²ĞíÊÇ¸öÓÃÓÚ¼ä½ÓË÷ÒıµÄÊı¾İ¿é£¬Ò²ĞíÊÇ×îÖÕµÄÊı¾İ¿é¡£²»¹ÜÔõÑù£¬´ËÊ±¶¼Ó¦¸ÃÎªÏàÓ¦µÄÊı¾İ<span
class=GramE>¿é·ÖÅä</span>¿Õ¼ä¡£<span lang=EN-US><o:p></o:p></span></span></p>

<p class=MsoNormal align=left style='margin-left:21.25pt;text-align:left;
text-indent:-21.25pt;mso-list:l0 level1 lfo1;tab-stops:list 21.25pt;mso-layout-grid-align:
none;text-autospace:none'><![if !supportLists]><span lang=EN-US
style='font-family:ËÎÌå;mso-hansi-font-family:Wingdings;mso-bidi-font-family:
ËÎÌå;color:black;mso-font-kerning:0pt'><span style='mso-list:Ignore'>¡¤<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]><span
style='font-family:ËÎÌå;mso-hansi-font-family:"Times New Roman";color:black;
mso-font-kerning:0pt'>Òª·ÖÅä¿Õ¼ä£¬Ê×ÏÈÓ¦¸ÃÈ·¶¨´ÓÎïÀíÉè±¸ÉÏºÎ´¦¶ÁÈ¡Ä¿±ê¿é¡£¸ù¾İ·ÖÅäËã·¨£¬Ëù·ÖÅäµÄÊı¾İ<span class=GramE>¿éÓ¦¸Ã</span>ÓëÉÏÒ»´ÎÒÑ·ÖÅäµÄÊı¾İ¿éÔÚÉè±¸ÉÏÁ¬Ğø´æ·Å¡£Îª´ËÄ¿µÄ£¬ÔÚ<span
lang=EN-US>ext2_inode_info</span>½á¹¹ÖĞÉèÖÃÁËÁ½¸öÓò<span lang=EN-US>i_next_alloc_block</span>ºÍ<span
lang=EN-US>i_next_alloc_goal</span>¡£Ç°ÕßÓÃÀ´¼ÇÂ¼ÏÂÒ»´ÎÒª·ÖÅäµÄÎÄ¼ş<span class=GramE>ÄÚ¿éºÅ</span>£¬¶øºóÕßÔòÓÃÀ´¼ÇÂ¼Ï£ÍûÏÂÒ»´ÎÄÜ·ÖÅäµÄÉè±¸ÉÏµÄ¿éºÅ¡£ÔÚÕı³£Çé¿öÏÂ£¬¶ÔÎÄ¼şµÄÀ©³äÊÇË³ĞòµÄ£¬Òò´Ë£¬Ã¿´ÎËù·ÖÅäµÄÎÄ¼ş<span
class=GramE>ÄÚ¿éºÅ</span>¶¼ÓëÇ°Ò»´ÎµÄÁ¬Ğø£¬¶øÀíÏëÉÏÀ´Ëµ£¬Éè±¸ÉÏ<span class=GramE>µÄ¿éºÅÒ²</span>Í¬ÑùÁ¬Ğø£¬¶şÕßÆ½ĞĞµØÏòÇ°ÍÆ½ø¡£ÕâÖÖÀíÏëµÄ¡°½¨Òé¿éºÅ¡±¾ÍÊÇÓÉ<span
lang=EN-US>ext2_find_goal</span>£¨£©º¯ÊıÀ´ÕÒµÄ¡£<span lang=EN-US><o:p></o:p></span></span></p>

<p class=MsoNormal align=left style='margin-left:21.25pt;text-align:left;
text-indent:-21.25pt;mso-list:l0 level1 lfo1;tab-stops:list 21.25pt;mso-layout-grid-align:
none;text-autospace:none'><![if !supportLists]><span lang=EN-US
style='font-family:ËÎÌå;mso-hansi-font-family:Wingdings;mso-bidi-font-family:
ËÎÌå;color:black;mso-font-kerning:0pt'><span style='mso-list:Ignore'>¡¤<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]><span
style='font-family:ËÎÌå;mso-hansi-font-family:"Times New Roman";color:black;
mso-font-kerning:0pt'>Éè±¸ÉÏ¾ßÌåÎïÀí¿éµÄ·ÖÅä£¬ÒÔ¼°ÎÄ¼şÄÚÊı¾İ¿éÓëÎïÀí¿éÖ®¼äÓ³ÉäµÄ½¨Á¢£¬¶¼ÊÇµ÷ÓÃ<span lang=EN-US>ext2_alloc_branch</span>£¨£©º¯ÊıÍê³ÉµÄ¡£µ÷ÓÃÖ®Ç°£¬ÏÈÒªËã³ö»¹ÓĞ¼¸¼¶Ë÷ÒıĞèÒª½¨Á¢¡£<span
lang=EN-US><o:p></o:p></span></span></p>

<p class=MsoNormal align=left style='margin-left:21.25pt;text-align:left;
text-indent:-21.25pt;mso-list:l0 level1 lfo1;tab-stops:list 21.25pt;mso-layout-grid-align:
none;text-autospace:none'><![if !supportLists]><span lang=EN-US
style='font-family:ËÎÌå;mso-hansi-font-family:Wingdings;mso-bidi-font-family:
ËÎÌå;color:black;mso-font-kerning:0pt'><span style='mso-list:Ignore'>¡¤<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]><span
style='font-family:ËÎÌå;mso-hansi-font-family:"Times New Roman";color:black;
mso-font-kerning:0pt'>´Ó<span lang=EN-US>ext2_alloc_branch</span>£¨£©·µ»ØÒÔºó£¬ÎÒÃÇÒÑ¾­´ÓÉè±¸ÉÏ·ÖÅäÁËËùĞèµÄÊı¾İ¿é£¬°üÀ¨ÓÃÓÚ¼ä½ÓË÷ÒıµÄÖĞ¼äÊı¾İ¿é¡£µ«ÊÇ£¬Ô­ÏÈÓ³Éä¿ªÊ¼¶Ï¿ªµÄ<span
class=GramE>×î</span>¸ß²ãÉÏËù·ÖÅäµÄÊı¾İ<span class=GramE>¿éºÅÖ»ÊÇ</span>¼ÇÂ¼ÁËÆä<span lang=EN-US>Indirect</span>½á¹¹ÖĞµÄ<span
lang=EN-US>key</span>Óò£¬È´²¢Ã»ÓĞĞ´ÈëÏàÓ¦µÄË÷Òı±íÖĞ¡£ÏÖÔÚ£¬¾ÍÒª°Ñ¶Ï¿ªµÄ¡°Ê÷Ö¦¡±½Óµ½Õû¸öË÷ÒıÊ÷ÉÏ£¬Í¬Ê±£¬»¹ĞèÒª¶ÔÎÄ¼şËùÊô<span
lang=EN-US>inode</span>½á¹¹ÖĞµÄÓĞ¹ØÄÚÈİ×öÒ»Ğ©µ÷Õû¡£ÕâĞ©²Ù×÷¶¼ÊÇÓÉ<span lang=EN-US>ext2_splice_branch</span>£¨£©º¯ÊıÍê³É¡£<span
lang=EN-US><o:p></o:p></span></span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US style='font-family:ËÎÌå;mso-hansi-font-family:
"Times New Roman";color:black;mso-font-kerning:0pt'><span
style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-spacerun:yes'>&nbsp;</span></span><span style='font-family:ËÎÌå;
mso-hansi-font-family:"Times New Roman";color:black;mso-font-kerning:0pt'>µ½´ËÎªÖ¹£¬ÍòÊÂ¾ß±¸£¬Ôò×ªµ½±êºÅ<span
lang=EN-US>got_it</span>´¦£¬°ÑÓ³ÉäºóµÄÊı¾İ¿éÁ¬Í¬Éè±¸ºÅÖÃÈë<span lang=EN-US>bh_result</span>ËùÖ¸µÄ»º³åÇø½á¹¹ÖĞ£¬Õâ¾ÍÍê³ÉÁËÊı¾İ¿éµÄ·ÖÅä¡£<span
lang=EN-US><o:p></o:p></span></span></p>

<p class=MsoNormal align=left style='text-align:left;mso-layout-grid-align:
none;text-autospace:none'><span lang=EN-US style='font-family:ËÎÌå;mso-hansi-font-family:
"Times New Roman";color:black;mso-font-kerning:0pt'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

</div>

</body>


<!-- Mirrored from www.kerneltravel.net/kernel-book/ç¬¬ä¹ç« %20Ext2æ–‡ä»¶ç³»ç»Ÿ/9.5.3.htm by HTTrack Website Copier/3.x [XR&CO'2008], Sat, 29 Dec 2012 03:01:25 GMT -->
</html>
